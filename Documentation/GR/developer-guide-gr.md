# Οδηγός Προγραμματιστή

Αυτός ο οδηγός παρέχει τεχνική τεκμηρίωση για προγραμματιστές που εργάζονται στο έργο Secure E-Shop, συμπεριλαμβανομένης της δομής του κώδικα, των λεπτομερειών αρχιτεκτονικής και των ροών εργασίας ανάπτυξης.

## Δομή Έργου

Το έργο Secure E-Shop ακολουθεί μια τυπική δομή έργου Django με πρόσθετες βελτιώσεις ασφαλείας:

```
secure-eshop/
├── certificates/        # Πιστοποιητικά HTTPS
├── db.sqlite3           # Βάση δεδομένων SQLite
├── eshop/               # Κύρια εφαρμογή
│   ├── migrations/      # Μεταναστεύσεις βάσης δεδομένων
│   ├── static/          # Στατικά assets (CSS, JS)
│   │   ├── css/
│   │   ├── img/
│   │   └── js/
│   ├── templates/       # HTML templates
│   ├── admin.py         # Διαμόρφωση διαχειριστικού περιβάλλοντος
│   ├── forms.py         # Ορισμοί φορμών
│   ├── models.py        # Μοντέλα βάσης δεδομένων
│   ├── tests.py         # Περιπτώσεις δοκιμών
│   ├── urls.py          # Δρομολόγηση URL
│   └── views.py         # Συναρτήσεις προβολής
├── eshop_project/       # Διαμόρφωση έργου
│   ├── settings.py      # Ρυθμίσεις Django
│   ├── urls.py          # Κύρια δρομολόγηση URL
│   └── wsgi.py          # Διαμόρφωση WSGI
├── media/               # Περιεχόμενο που ανεβάζουν οι χρήστες
├── manage.py            # Σενάριο διαχείρισης Django
└── requirements.txt     # Εξαρτήσεις πακέτων
```

## Βασική Αρχιτεκτονική

### Μοτίβο MTV (Model-Template-View)

Η εφαρμογή ακολουθεί το μοτίβο MTV του Django:

1. **Models (`models.py`)**: Ορίζουν τη δομή της βάσης δεδομένων
2. **Templates (`templates/`)**: Χειρίζονται τη λογική παρουσίασης
3. **Views (`views.py`)**: Επεξεργάζονται τα αιτήματα χρηστών και επιστρέφουν αποκρίσεις

### Βασικά Στοιχεία

#### Μοντέλα

Το σχήμα της βάσης δεδομένων περιλαμβάνει:

- **Product**: Αποθηκεύει αντικείμενα αποθέματος με όνομα, περιγραφή, τιμή και εικόνα
- **Cart**: Σχέση one-to-one με τον Χρήστη για την παρακολούθηση του καλαθιού αγορών του
- **CartItem**: Αντικείμενα στο καλάθι ενός χρήστη με ποσότητα
- **ShippingAddress**: Στοιχεία αποστολής χρήστη (όνομα, διεύθυνση, πόλη, ταχυδρομικός κώδικας, χώρα)
- **Order**: Εγγραφές ολοκληρωμένων παραγγελιών με κατάσταση και συνολική τιμή
- **OrderItem**: Προϊόντα που περιλαμβάνονται σε μια παραγγελία με ποσότητα και τιμή τη στιγμή της αγοράς

Βασικές σχέσεις:
- Ένας χρήστης έχει ένα καλάθι
- Το καλάθι περιέχει πολλαπλά αντικείμενα καλαθιού
- Ο χρήστης μπορεί να έχει πολλαπλές διευθύνσεις αποστολής
- Ο χρήστης μπορεί να κάνει πολλαπλές παραγγελίες
- Οι παραγγελίες περιέχουν πολλαπλά αντικείμενα παραγγελίας

#### Προβολές

Βασικές προβολές υλοποιούν τη ροή της εφαρμογής:

- **login_view**: Χειρίζεται την αυθεντικοποίηση χρηστών με προστασία από απαρίθμηση χρηστών
- **catalog_view**: Εμφανίζει προϊόντα, επεξεργάζεται ερωτήματα αναζήτησης με προστασία XSS
- **add_to_cart**: Endpoint AJAX για προσθήκη προϊόντων στο καλάθι με προστασία CSRF
- **payment_view**: Διαδικασία ολοκλήρωσης αγοράς δύο βημάτων (καταχώρηση διεύθυνσης και επιβεβαίωση παραγγελίας)

#### Φόρμες

- **LoginForm**: Φόρμα σύνδεσης με προστασία από επιθέσεις χρονισμού και απαρίθμηση χρηστών
- **ShippingAddressForm**: Φόρμα για συλλογή πληροφοριών αποστολής με καθαρισμό εισόδων

#### Μοτίβα URL

Βασικά μοτίβα URL:
- `/login/`: Αυθεντικοποίηση χρήστη
- `/logout/`: Τερματισμός συνόδου
- `/`: Κατάλογος προϊόντων (αρχική σελίδα)
- `/add-to-cart/`: Endpoint AJAX για διαχείριση καλαθιού
- `/payment/`: Επεξεργασία ολοκλήρωσης αγοράς και παραγγελίας

## Ρύθμιση Περιβάλλοντος Ανάπτυξης

Δείτε το [INSTALLATION.md](INSTALLATION.md) για λεπτομερείς οδηγίες ρύθμισης.

## Ροή Εργασίας Ανάπτυξης

### Κάνοντας Αλλαγές Κώδικα

1. Δημιουργήστε ένα κλάδο χαρακτηριστικών από το `main`:
   ```bash
   git checkout -b feature/your-feature-name
   ```

2. Κάντε τις αλλαγές σας

3. Εκτελέστε δοκιμές για να διασφαλίσετε τη λειτουργικότητα και την ασφάλεια:
   ```bash
   python manage.py test
   ```

4. Υποβάλετε τις αλλαγές σας:
   ```bash
   git add .
   git commit -m "Περιγραφή των αλλαγών"
   git push origin feature/your-feature-name
   ```

### Αλλαγές Βάσης Δεδομένων

Όταν τροποποιείτε μοντέλα:

1. Ενημερώστε το μοντέλο στο `models.py`

2. Δημιουργήστε μεταναστεύσεις:
   ```bash
   python manage.py makemigrations eshop
   ```

3. Εφαρμόστε τις μεταναστεύσεις:
   ```bash
   python manage.py migrate
   ```

### Στατικά Αρχεία

Όταν εργάζεστε με στατικά αρχεία:

1. Προσθέστε/τροποποιήστε αρχεία στον κατάλογο `static/` της εφαρμογής
2. Κατά την ανάπτυξη, ο `runserver` του Django θα εξυπηρετεί αυτόματα αυτά τα αρχεία
3. Για ανάπτυξη, εκτελέστε `collectstatic`:
   ```bash
   python manage.py collectstatic
   ```

## Ροή Εφαρμογής

### Αυθεντικοποίηση Χρήστη

1. Ο χρήστης μεταβαίνει στη σελίδα σύνδεσης
2. Τα διαπιστευτήρια υποβάλλονται μέσω ασφαλούς φόρμας
3. Το LoginForm επικυρώνει με προστασία από επιθέσεις χρονισμού
4. Το Django αυθεντικοποιεί τον χρήστη
5. Το κλειδί συνόδου αλλάζει κυκλικά για ασφάλεια
6. Ο χρήστης ανακατευθύνεται στον κατάλογο

### Περιήγηση και Αναζήτηση Προϊόντων

1. Ο κατάλογος εμφανίζει όλα τα προϊόντα
2. Η φόρμα αναζήτησης επιτρέπει το φιλτράρισμα με βάση το όνομα/περιγραφή
3. Τα ερωτήματα αναζήτησης καθαρίζονται από XSS
4. Τα αποτελέσματα εμφανίζονται με την κατάσταση του καλαθιού στο υποσέλιδο

### Διαχείριση Καλαθιού

1. Ο χρήστης κάνει κλικ στο "Προσθήκη στο Καλάθι" σε ένα προϊόν
2. Η JavaScript στέλνει αίτημα AJAX με token CSRF
3. Ο διακομιστής επικυρώνει το αίτημα και προσθέτει το προϊόν στο καλάθι
4. Ο μετρητής καλαθιού ενημερώνεται χωρίς επαναφόρτωση της σελίδας
5. Τα αντικείμενα καλαθιού εμφανίζονται στο υποσέλιδο

### Διαδικασία Ολοκλήρωσης Αγοράς

1. Ο χρήστης μεταβαίνει στη σελίδα πληρωμής
2. Η διεύθυνση αποστολής καταχωρείται μέσω επικυρωμένης φόρμας
3. Τα δεδομένα φόρμας καθαρίζονται και αποθηκεύονται
4. Η σελίδα επιβεβαίωσης παραγγελίας εμφανίζει τα περιεχόμενα του καλαθιού και τη διεύθυνση
5. Ο χρήστης επιβεβαιώνει την παραγγελία
6. Η παραγγελία αποθηκεύεται στη βάση δεδομένων
7. Αποστέλλεται email επιβεβαίωσης στον διαχειριστή
8. Το καλάθι αδειάζει
9. Ο χρήστης ανακατευθύνεται στον κατάλογο με μήνυμα επιτυχίας

## Οδηγίες Ανάπτυξης Ασφάλειας

### Αυθεντικοποίηση & Εξουσιοδότηση

- Όλες οι προβολές που απαιτούν αυθεντικοποίηση θα πρέπει να χρησιμοποιούν τον διακοσμητή `@login_required`
- Πρόσθετοι έλεγχοι πρόσβασης θα πρέπει να υλοποιούνται όπου οι χρήστες μπορούν να έχουν πρόσβαση μόνο στα δικά τους δεδομένα
- Πάντα να αλλάζετε κυκλικά τα κλειδιά συνόδου μετά τη σύνδεση χρησιμοποιώντας `request.session.cycle_key()`

### Επικύρωση Εισόδου

- Πάντα να καθαρίζετε τις εισόδους χρηστών χρησιμοποιώντας bleach:
  ```python
  cleaned_input = bleach.clean(user_input)
  ```
- Επικυρώνετε όλες τις εισόδους φόρμας με κατάλληλους επικυρωτές
- Για ερωτήματα αναζήτησης ή άλλες παραμέτρους GET, καθαρίστε πριν τη χρήση:
  ```python
  search_query = bleach.clean(request.GET.get('q', ''))
  ```

### Ασφάλεια Βάσης Δεδομένων

- Πάντα να χρησιμοποιείτε το Django ORM για ερωτήματα βάσης δεδομένων
- Ποτέ μη χρησιμοποιείτε απευθείας raw ερωτήματα SQL
- Όταν φιλτράρετε με βάση δεδομένα που παρέχονται από τον χρήστη, καθαρίστε τις εισόδους:
  ```python
  products = Product.objects.filter(Q(name__icontains=clean_query))
  ```

### Προστασία CSRF

- Πάντα να συμπεριλαμβάνετε το token CSRF σε φόρμες:
  ```html
  <form method="post">
      {% csrf_token %}
      <!-- πεδία φόρμας -->
  </form>
  ```
- Για αιτήματα AJAX, συμπεριλάβετε το token CSRF στις κεφαλίδες:
  ```javascript
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  fetch('/api/endpoint/', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(data)
  })
  ```

### Πρόληψη XSS

- Ποτέ μη χρησιμοποιείτε το φίλτρο `|safe` ή το `{% autoescape off %}` χωρίς προσεκτική εξέταση
- Χρησιμοποιήστε το `textContent` της JavaScript αντί για `innerHTML` όταν είναι δυνατόν
- Καθαρίστε όλες τις εισόδους χρηστών πριν την απόδοση στα templates

### Χειρισμός Σφαλμάτων

- Χρησιμοποιήστε μπλοκ try/except για λειτουργίες επιρρεπείς σε σφάλματα
- Καταγράψτε σφάλματα με το κατάλληλο πλαίσιο
- Επιστρέψτε φιλικά προς τον χρήστη μηνύματα σφάλματος χωρίς διαρροή ευαίσθητων πληροφοριών

## Δοκιμές

### Εκτέλεση Δοκιμών

Εκτέλεση όλων των δοκιμών:
```bash
python manage.py test
```

Εκτέλεση συγκεκριμένης δοκιμής:
```bash
python manage.py test eshop.tests.TestClassName.test_method_name
```

### Συγγραφή Δοκιμών

Το έργο περιλαμβάνει διάφορους τύπους δοκιμών:

1. **Δοκιμές Μοντέλων**: Δοκιμάζουν μοντέλα και σχέσεις βάσης δεδομένων
2. **Δοκιμές Προβολών**: Δοκιμάζουν αποκρίσεις HTTP και λογική προβολών
3. **Δοκιμές Φορμών**: Δοκιμάζουν επικύρωση φορμών και ασφάλεια
4. **Δοκιμές Ασφαλείας**: Δοκιμάζουν για ευπάθειες όπως XSS, CSRF και SQL injection

Όταν προσθέτετε χαρακτηριστικά, γράψτε δοκιμές που καλύπτουν:
- Κανονική λειτουργικότητα
- Οριακές περιπτώσεις
- Θέματα ασφαλείας

Παράδειγμα δοκιμής για προστασία XSS:
```python
def test_search_xss_protection(self):
    self.client.login(username='testuser', password='12345')
    
    # Προσπάθεια XSS στο ερώτημα αναζήτησης
    xss_payload = "<script>alert('XSS')</script>"
    response = self.client.get(f'/?q={xss_payload}')
    
    # Επαλήθευση ότι η απόκριση δεν περιέχει το raw tag script
    self.assertEqual(response.status_code, 200)
    self.assertNotContains(response, xss_payload)
    
    # Επαλήθευση ότι ο όρος αναζήτησης καθαρίστηκε
    self.assertContains(response, "Αποτελέσματα αναζήτησης")
    # Έλεγχος ότι περιέχει την καθαρισμένη έκδοση
    self.assertContains(response, "&lt;script&gt;")
```

## Χρήσιμες Εντολές

```bash
# Εκτέλεση του διακομιστή ανάπτυξης με HTTPS
python manage.py runserver_plus --cert-file=certificates/cert.pem --key-file=certificates/key.pem

# Δημιουργία μεταναστεύσεων
python manage.py makemigrations eshop

# Εφαρμογή μεταναστεύσεων
python manage.py migrate

# Δημιουργία υπερχρήστη
python manage.py createsuperuser

# Ρύθμιση OTP για διαχειριστή
python manage.py add_otp_device admin

# Συλλογή στατικών αρχείων
python manage.py collectstatic

# Εκτέλεση δοκιμών
python manage.py test

# Εκτέλεση συγκεκριμένων δοκιμών
python manage.py test eshop.tests.TestClassName

# Django shell (με αυτόματη εισαγωγή)
python manage.py shell_plus
```

## Συμβουλές Αποσφαλμάτωσης

### Django Debug Toolbar

Το έργο περιλαμβάνει το Django Debug Toolbar για ανάπτυξη. Για να το χρησιμοποιήσετε:

1. Βεβαιωθείτε ότι `DEBUG = True` στο settings.py
2. Προσπελάστε τον ιστότοπο και η γραμμή εργαλείων θα εμφανιστεί στη δεξιά πλευρά
3. Χρησιμοποιήστε την για να επιθεωρήσετε ερωτήματα SQL, templates, δεδομένα αιτημάτων και άλλα

### Καταγραφή

Η εφαρμογή χρησιμοποιεί τη μονάδα καταγραφής της Python. Προβολή καταγραφών στο `logs/app.log`:

```bash
tail -f logs/app.log
```

Προσαρμοσμένοι loggers είναι διαθέσιμοι για συγκεκριμένα στοιχεία:
- `security`: Καταγράφει συμβάντα σχετικά με την ασφάλεια
- `orders`: Καταγράφει επεξεργασία παραγγελιών

Για να χρησιμοποιήσετε αυτούς τους loggers:
```python
import logging

# Λήψη ενός logger
logger = logging.getLogger('security')

# Καταγραφή ενός συμβάντος
logger.warning("Ύποπτη προσπάθεια σύνδεσης από IP: %s", ip_address)
```

## Βέλτιστες Πρακτικές Ανάπτυξης

1. **Ακολουθήστε τις Οδηγίες Ασφαλείας**: Ακολουθείτε πάντα τις πρακτικές ασφαλείας που περιγράφονται σε αυτό το έγγραφο
2. **Στυλ Κώδικα**: Τηρείτε τις οδηγίες στυλ PEP 8
3. **Τεκμηρίωση**: Τεκμηριώνετε κώδικα σχετικό με την ασφάλεια με σχόλια
4. **Δοκιμές**: Γράφετε δοκιμές για όλα τα νέα χαρακτηριστικά, ειδικά για χαρακτηριστικά ασφαλείας
5. **Εξαρτήσεις**: Διατηρείτε τις εξαρτήσεις ενημερωμένες στις τελευταίες ασφαλείς εκδόσεις
6. **Διαχείριση Μυστικών**: Ποτέ μην δεσμεύετε μυστικά στο σύστημα ελέγχου εκδόσεων· χρησιμοποιείτε μεταβλητές περιβάλλοντος
7. **Αναθεωρήσεις Κώδικα**: Όλες οι αλλαγές που σχετίζονται με την ασφάλεια θα πρέπει να υπόκεινται σε αναθεώρηση από συναδέλφους

## Αντιμετώπιση Κοινών Προβλημάτων

### Προβλήματα Πιστοποιητικού HTTPS

Εάν αντιμετωπίζετε σφάλματα πιστοποιητικού SSL:
```bash
# Αναδημιουργήστε τα πιστοποιητικά
openssl req -x509 -newkey rsa:4096 -keyout certificates/key.pem -out certificates/cert.pem -days 365 -nodes
```

### Συγκρούσεις Μετανάστευσης Βάσης Δεδομένων

Εάν αντιμετωπίζετε συγκρούσεις μετανάστευσης:
```bash
# Επαναφορά της βάσης δεδομένων (μόνο για ανάπτυξη!)
rm db.sqlite3
rm -r eshop/migrations/0*.py
python manage.py makemigrations eshop
python manage.py migrate
```

### Στατικά Αρχεία Δεν Φορτώνονται

Εάν τα στατικά αρχεία δεν φορτώνονται σωστά:
```bash
python manage.py collectstatic --noinput --clear
```

### Προβλήματα Ρύθμισης OTP

Εάν αντιμετωπίζετε προβλήματα με τη ρύθμιση OTP:
```bash
# Ελέγξτε αν ο κωδικός QR δημιουργήθηκε
ls -la admin_qrcode.png

# Αναδημιουργήστε τη συσκευή OTP
python manage.py add_otp_device admin
```

## Πρόσθετοι Πόροι

- [Τεκμηρίωση Django](https://docs.djangoproject.com/)
- [Βέλτιστες Πρακτικές Ασφαλείας Django](https://docs.djangoproject.com/en/stable/topics/security/)
- [OWASP Top Ten](https://owasp.org/www-project-top-ten/)
- [Django Debug Toolbar](https://django-debug-toolbar.readthedocs.io/)
- [Τεκμηρίωση Bleach](https://bleach.readthedocs.io/)
