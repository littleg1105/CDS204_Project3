# Τεκμηρίωση Ασφάλειας

Αυτό το έγγραφο παρέχει μια ολοκληρωμένη επισκόπηση των χαρακτηριστικών ασφαλείας που έχουν υλοποιηθεί στην εφαρμογή Secure E-Shop, συμπεριλαμβανομένων των προστασιών έναντι κοινών ευπαθειών web και των βέλτιστων πρακτικών ασφαλείας.

## Αρχιτεκτονική Ασφαλείας

Η εφαρμογή Secure E-Shop παρουσιάζει μια προσέγγιση με προτεραιότητα την ασφάλεια με πολλαπλά επίπεδα προστασίας:

- **Ασφάλεια Αυθεντικοποίησης**: Προστασία έναντι επιθέσεων brute force, επιθέσεων χρονισμού και απαρίθμησης χρηστών
- **Προστασία Δεδομένων**: Διεξοδικός καθαρισμός και επικύρωση εισόδων για όλες τις εισόδους χρηστών
- **Ασφάλεια Μεταφοράς**: Σωστά ρυθμισμένο HTTPS με υλοποίηση HSTS
- **Προστασία Έναντι Κοινών Επιθέσεων**: Ολοκληρωμένα μέτρα έναντι XSS, CSRF και SQL Injection
- **Rate Limiting**: Καλά υλοποιημένο rate limiting για ευαίσθητες λειτουργίες
- **Ασφάλεια Κωδικών Πρόσβασης**: Ασφαλής αποθήκευση κωδικών πρόσβασης με χρήση Argon2 hashing

## Ασφάλεια Αυθεντικοποίησης

### Προστασία Σύνδεσης

Η εφαρμογή υλοποιεί πολλαπλά μέτρα ασφαλείας στο σύστημα σύνδεσης:

1. **Προστασία Έναντι Επιθέσεων Χρονισμού**:
   - Σύγκριση συμβολοσειρών σταθερού χρόνου με χρήση `hmac.compare_digest()`
   - Σταθερός χρόνος απόκρισης (ελάχιστο 300ms) ανεξάρτητα από το αποτέλεσμα αυθεντικοποίησης
   - Τυχαία καθυστέρηση (0-100ms) για προσθήκη μεταβλητότητας στο χρόνο απόκρισης

```python
# Από το LoginForm στο forms.py
def constant_time_compare(val1, val2):
    return hmac.compare_digest(
        str(val1).encode('utf-8'),
        str(val2).encode('utf-8')
    )

# Αυθεντικοποίηση με προστασία έναντι επιθέσεων χρονισμού
user = authenticate(self.request, username=username, password=password)

# Σταθερή καθυστέρηση χρόνου + τυχαίος θόρυβος
random_delay = secrets.randbelow(100) / 1000
if execution_time < 0.3:
    time.sleep(0.3 - execution_time + random_delay)
```

2. **Πρόληψη Απαρίθμησης Χρηστών**:
   - Γενικά μηνύματα σφάλματος που δεν αποκαλύπτουν αν υπάρχει το όνομα χρήστη
   - Πανομοιότυπος χρονισμός για υπάρχοντες/μη υπάρχοντες χρήστες
   - Ίδια συμπεριφορά για όλες τις αποτυχίες αυθεντικοποίησης

3. **Προστασία από Brute Force**:
   - Ενσωμάτωση με django-axes για την παρακολούθηση αποτυχημένων προσπαθειών σύνδεσης
   - Κλείδωμα μετά από 5 αποτυχημένες προσπάθειες για 1 ώρα
   - Κλείδωμα βάσει συνδυασμού ονόματος χρήστη/διεύθυνσης IP/user-agent
   - Rate limiting (10 προσπάθειες ανά λεπτό ανά IP)

### Αποθήκευση Κωδικών Πρόσβασης

1. **Αλγόριθμος Hashing**: 
   - Χρησιμοποιεί το Argon2 (νικητής του Password Hashing Competition)
   - Πολλαπλά εφεδρικά hashers για συμβατότητα προς τα πίσω

```python
# Από το settings.py
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.Argon2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2PasswordHasher',
    'django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher',
]
```

2. **Επικύρωση Κωδικών Πρόσβασης**:
   - Απαίτηση ελάχιστου μήκους
   - Έλεγχος κοινών κωδικών πρόσβασης
   - Έλεγχος ομοιότητας με χαρακτηριστικά χρήστη
   - Απαίτηση μη-αριθμητικών χαρακτήρων

### Διαχείριση Συνόδου

1. **Ασφάλεια Συνόδου**:
   - Κυκλική εναλλαγή κλειδιού συνόδου μετά από επιτυχή σύνδεση (προστασία από session fixation)
   - Ασφαλή cookies συνόδου (μόνο HTTPS, σημαία HTTPOnly)
   - Πολιτική SameSite cookie για πρόληψη CSRF

```python
# Μετά από επιτυχή αυθεντικοποίηση
request.session.cycle_key()
```

2. **Χειρισμός Δεδομένων Συνόδου**:
   - Ασφαλής αποθήκευση δεδομένων συνόδου στη βάση δεδομένων
   - Σωστός καθαρισμός μετά την ολοκλήρωση της παραγγελίας
   - Προσωρινή αποθήκευση ευαίσθητων δεδομένων (π.χ., διεύθυνση αποστολής)

```python
# Αποθήκευση δεδομένων στη σύνοδο
request.session['shipping_address_id'] = address.id

# Καθαρισμός μετά τη χρήση
if 'shipping_address_id' in request.session:
    del request.session['shipping_address_id']
```

## Αυθεντικοποίηση Δύο Παραγόντων (2FA)

Το περιβάλλον διαχείρισης προστατεύεται με αυθεντικοποίηση δύο παραγόντων με κωδικό μιας χρήσης βάσει χρόνου (TOTP):

1. **Υλοποίηση OTP**:
   - Προσαρμοσμένη εντολή διαχείρισης για τη ρύθμιση OTP για χρήστες
   - Δημιουργία κωδικού QR για εύκολη ρύθμιση με εφαρμογές αυθεντικοποίησης
   - Εφεδρικοί κωδικοί για ανάκτηση λογαριασμού

2. **Διαχείριση OTP**:
   - Προσαρμοσμένη διαχείριση συσκευών OTP για διαχειριστές
   - Δυνατότητα επαναφοράς συσκευών OTP όταν χρειάζεται

## Προστασία Έναντι Κοινών Ευπαθειών Web

### Προστασία από Cross-Site Scripting (XSS)

Πολλαπλά επίπεδα προστασίας XSS:

1. **Καθαρισμός Εισόδων**:
   - Όλες οι είσοδοι χρήστη καθαρίζονται με bleach
   - Επικύρωση τύπου για αριθμητικά πεδία
   - Διαφυγή οντοτήτων HTML

```python
# Από το catalog_view στο views.py
search_query = request.GET.get('q', '')
clean_query = bleach.clean(search_query)
```

2. **Διαφυγή Εξόδου**:
   - Αυτόματη διαφυγή προτύπων Django
   - Διπλός καθαρισμός στους επεξεργαστές περιεχομένου
   - Ασφαλή χαρακτηριστικά δεδομένων για πρόσβαση JavaScript

3. **Πολιτική Ασφαλείας Περιεχομένου**:
   - Αυστηρή ρύθμιση κεφαλίδας CSP
   - Περιορισμοί πόρων (αυτο-προέλευση για τους περισσότερους πόρους)
   - Περιορισμένες εξωτερικές πηγές (μόνο CDN)

```python
# Από το settings.py
CSP_DEFAULT_SRC = ("'self'",)
CSP_SCRIPT_SRC = ("'self'", "https://cdn.jsdelivr.net")
CSP_STYLE_SRC = ("'self'", "https://cdn.jsdelivr.net")
CSP_FONT_SRC = ("'self'", "https://cdn.jsdelivr.net")
CSP_IMG_SRC = ("'self'", "data:")
CSP_CONNECT_SRC = ("'self'",)
```

### Προστασία από Cross-Site Request Forgery (CSRF)

Ολοκληρωμένη προστασία CSRF υλοποιημένη:

1. **Tokens CSRF**:
   - Ενσωματωμένο middleware CSRF του Django
   - Token CSRF σε όλες τις φόρμες
   - Token CSRF σε αιτήματα AJAX

```html
<!-- Σε πρότυπα φορμών -->
<form method="post">
    {% csrf_token %}
    <!-- πεδία φόρμας -->
</form>
```

```javascript
// Από το cart.js
const csrfToken = this.getAttribute('data-csrf-token');

fetch('/add-to-cart/', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({ product_id: productId })
})
```

2. **Ρυθμίσεις Cookie**:
   - Cookies CSRF με πολιτική SameSite
   - Σημαία Secure για μόνο HTTPS
   - Περιορισμένες αξιόπιστες προελεύσεις

```python
# Από το settings.py
CSRF_COOKIE_SECURE = True
CSRF_COOKIE_SAMESITE = 'Lax'
```

### Προστασία από SQL Injection

Ασφαλής αλληλεπίδραση με τη βάση δεδομένων:

1. **Django ORM**:
   - Αποκλειστική χρήση του Django ORM για ερωτήματα βάσης δεδομένων
   - Παραμετροποιημένα ερωτήματα για όλες τις λειτουργίες βάσης δεδομένων
   - Όχι raw ερωτήματα SQL

```python
# Ασφαλές ερώτημα χρησιμοποιώντας το ORM
products = Product.objects.filter(
    Q(name__icontains=clean_query) | 
    Q(description__icontains=clean_query)
)
```

2. **Καθαρισμός Εισόδων**:
   - Όλες οι είσοδοι καθαρίζονται πριν από τη χρήση σε ερωτήματα
   - Επικύρωση τύπου για IDs και αριθμητικές τιμές

### Rate Limiting

Πολλαπλά επίπεδα rate limiting:

1. **Rate Limiting Σύνδεσης**:
   - 10 προσπάθειες ανά λεπτό ανά IP
   - django-axes για πρόσθετη προστασία από brute force

2. **Λειτουργίες Καλαθιού**:
   - 20 αιτήματα ανά λεπτό ανά χρήστη για προσθήκη/ενημέρωση/αφαίρεση

3. **Επεξεργασία Πληρωμών**:
   - 5 υποβολές ανά λεπτό ανά χρήστη

4. **Υλοποίηση**:
   - Περιορισμός βάσει IP ή ID χρήστη
   - Παρακολούθηση αριθμού αιτημάτων βάσει cache
   - Χειρισμός αποτυχίας με αποκρίσεις 429

```python
@ratelimit(key='ip', rate='10/m', method=['POST'], block=True)
def login_view(request):
    # Υλοποίηση προστατευμένης προβολής
```

## Ασφάλεια Επιπέδου Μεταφοράς

Υλοποίηση HTTPS:

1. **Ρύθμιση SSL**:
   - Ανακατεύθυνση SSL ενεργοποιημένη
   - Cookies μόνο HTTPS
   - Κεφαλίδες HSTS

2. **Κεφαλίδες Ασφαλείας**:
   - Strict-Transport-Security
   - X-Content-Type-Options: nosniff
   - X-XSS-Protection ενεργοποιημένη

```python
# Από το settings.py
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_HSTS_SECONDS = 31536000  # 1 έτος
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
```

## Επικύρωση Φόρμας και Καθαρισμός Εισόδων

Η εφαρμογή υλοποιεί διεξοδική επικύρωση φόρμας και καθαρισμό:

1. **Φόρμα ShippingAddress**:
   - Επικύρωση κανονικής έκφρασης για ταχυδρομικούς κώδικες, αριθμούς τηλεφώνου
   - Επικύρωση email με έλεγχο μορφής και επαλήθευση τομέα
   - Αυτόματος καθαρισμός HTML με bleach

2. **Φόρμα Login**:
   - Καθαρισμένα μηνύματα σφάλματος
   - Προστασία από επιθέσεις χρονισμού

Παράδειγμα επικύρωσης email με επαλήθευση τομέα:

```python
# Από το forms.py (ShippingAddressForm)
def clean_email(self):
    email = self.cleaned_data.get('email')
    
    if email:
        # Βασική επικύρωση μορφής με regex
        email_pattern = r'^[a-zA-Z0-9](?:[a-zA-Z0-9._%+-]{0,63}[a-zA-Z0-9])?@(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,63}$'
        if not re.match(email_pattern, email):
            raise ValidationError('Η διεύθυνση email δεν είναι έγκυρη. Ελέγξτε τη μορφή της.')
```

## Καταγραφή και Χειρισμός Σφαλμάτων

Καταγραφή συμβάντων ασφαλείας:

1. **Ρύθμιση Logger**:
   - Ξεχωριστός logger ασφαλείας
   - Χειριστές αρχείων και κονσόλας
   - Λεπτομερής μορφοποίηση

2. **Καταγραφόμενα Συμβάντα**:
   - Αποτυχημένες προσπάθειες σύνδεσης
   - Παραβιάσεις rate limit
   - Επεξεργασία πληρωμών
   - Συνθήκες σφάλματος

```python
# Από το settings.py
LOGGING = {
    # ...
    'loggers': {
        'security': {
            'handlers': ['console', 'file'],
            'level': 'INFO',
            'propagate': False,
        },
    }
}
```

## Γνωστοί Περιορισμοί και Κίνδυνοι Ασφαλείας

Παρά τα ολοκληρωμένα μέτρα ασφαλείας, αναγνωρίζονται οι ακόλουθοι περιορισμοί:

1. **Περιορισμοί Περιβάλλοντος Ανάπτυξης**:
   - Αυτο-υπογεγραμμένο πιστοποιητικό στην ανάπτυξη (δεν είναι κατάλληλο για παραγωγή)
   - Βάση δεδομένων SQLite (όχι ιδανική για παραγωγή)

2. **Απαιτούνται Πρόσθετα Μέτρα Ασφαλείας**:
   - Ολοκληρωμένο rate limiting για όλα τα endpoints API
   - Πρόσθετη επικύρωση για διευθύνσεις αποστολής
   - Ενσωμάτωση πραγματικής πύλης πληρωμών (η τρέχουσα υλοποίηση είναι προσομοιωμένη)
   - Πιο ολοκληρωμένη καταγραφή και παρακολούθηση
   - Υλοποίηση CAPTCHA

## Δοκιμές Ασφαλείας

Η εφαρμογή περιλαμβάνει ειδικές δοκιμές ασφαλείας:

1. **Δοκιμές Rate Limiting**:
   - Επαλήθευση ορίων ρυθμού για σύνδεση, λειτουργίες καλαθιού, πληρωμή
   - Επιβεβαίωση σωστών αποκρίσεων 429

2. **Δοκιμές CSRF**:
   - Διασφάλιση προστασίας CSRF σε όλες τις φόρμες
   - Επαλήθευση χειρισμού CSRF AJAX

3. **Δοκιμές XSS**:
   - Δοκιμή καθαρισμού εισόδων
   - Επιβεβαίωση διαφυγής εξόδου

4. **Δοκιμές Αυθεντικοποίησης**:
   - Προστασία από επιθέσεις χρονισμού
   - Μετριασμός brute force
   - Ασφάλεια συνόδου

## Συστάσεις Ασφαλείας

Για ανάπτυξη σε περιβάλλον παραγωγής, συνιστώνται τα ακόλουθα πρόσθετα μέτρα ασφαλείας:

1. **Τείχος Προστασίας Εφαρμογών Web (WAF)**:
   - Υλοποίηση WAF για πρόσθετη προστασία έναντι κοινών επιθέσεων

2. **Ενισχυμένη Αυθεντικοποίηση**:
   - Επέκταση αυθεντικοποίησης δύο παραγόντων σε όλους τους χρήστες
   - Υλοποίηση ενσωμάτωσης OAuth για σύνδεση τρίτων
   - Προσθήκη οπτικοποίησης πολυπλοκότητας κωδικού πρόσβασης

3. **Πρόσθετες Κεφαλίδες Ασφαλείας**:
   - Προσθήκη κεφαλίδας Referrer-Policy
   - Υλοποίηση κεφαλίδων Feature-Policy/Permissions-Policy
   - Εξέταση Subresource Integrity για πόρους CDN

4. **Ασφάλεια Υποδομής**:
   - Τακτικές ενημερώσεις ασφαλείας για όλα τα στοιχεία του συστήματος
   - Κρυπτογράφηση βάσης δεδομένων σε κατάσταση ηρεμίας
   - Προστασία DDoS
