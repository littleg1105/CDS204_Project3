# Vulnerability Implementation Plan for E-Shop Penetration Testing

## Overview
This document outlines the detailed plan for introducing controlled security vulnerabilities into the secure e-shop application for educational penetration testing purposes.

## Selected Vulnerabilities (3 Required + 2 Bonus)

### 1. SQL Injection (SQLi)
**Implementation Details:**
- **Location**: `eshop/views.py` - catalog_view function
- **Method**: Replace Django ORM queries with raw SQL using string concatenation
- **Vulnerable Parameter**: `search` query parameter
- **Attack Vector**: `/catalog/?search=' OR '1'='1`

**Code Changes:**
```python
# Instead of:
products = Product.objects.filter(name__icontains=search_query)

# Use:
cursor.execute(f"SELECT * FROM eshop_product WHERE name LIKE '%{search_query}%'")
```

### 2. Cross-Site Scripting (XSS)
**Implementation Details:**
- **Type**: Stored XSS
- **Location 1**: Product review system (new feature to add)
- **Location 2**: User profile bio field
- **Method**: Remove bleach sanitization and disable Django template escaping

**Code Changes:**
- Remove `bleach.clean()` from forms
- Use `|safe` filter in templates
- Add `{% autoescape off %}` blocks

### 3. Authentication Weakness - User Enumeration
**Implementation Details:**
- **Location**: `eshop/forms.py` - LoginForm
- **Method**: Different error messages for invalid username vs invalid password
- **Remove**: Timing attack protection
- **Remove**: Rate limiting middleware

**Code Changes:**
```python
# Vulnerable login logic:
if not User.objects.filter(username=username).exists():
    raise forms.ValidationError("Username does not exist")
elif not user.check_password(password):
    raise forms.ValidationError("Invalid password")
```

### 4. Broken Access Control (IDOR) - Bonus
**Implementation Details:**
- **Location**: Order viewing functionality
- **Method**: Use sequential integer IDs instead of UUIDs
- **Vulnerable Endpoint**: `/order/<id>/`
- **Attack**: Access other users' orders by incrementing ID

### 5. Weak Cryptography - Bonus
**Implementation Details:**
- **Password Hashing**: Change from Argon2 to MD5
- **Session Security**: Disable secure cookie flags
- **Encryption**: Remove or weaken field-level encryption

## Implementation Steps

### Phase 1: Security Removal
1. Disable security middleware (rate limiting, security headers)
2. Set DEBUG=True in production settings
3. Remove HTTPS enforcement
4. Disable CSRF protection for specific views

### Phase 2: Vulnerability Introduction
1. Implement SQL Injection in catalog search
2. Add review system with XSS vulnerability
3. Modify authentication to enable user enumeration
4. Change model IDs from UUID to sequential integers
5. Downgrade password hashing to MD5

### Phase 3: Documentation
1. Create exploitation guides for each vulnerability
2. Document proof-of-concept attacks
3. Prepare penetration testing report template

## File Modification List

### Core Files to Modify:
1. `eshop/views.py` - Add SQL injection
2. `eshop/forms.py` - Remove input sanitization, add user enumeration
3. `eshop/models/` - Change UUID to integer IDs
4. `eshop/templates/` - Remove auto-escaping
5. `eshop_project/settings.py` - Weaken security settings
6. `eshop/middleware.py` - Disable security middleware

### New Features to Add:
1. Product review system (for stored XSS)
2. User profile bio field (for persistent XSS)
3. Direct order access endpoint (for IDOR)

## Testing Plan

### Manual Testing:
1. SQL Injection: Use SQLMap and manual payloads
2. XSS: Test with alert() and more sophisticated payloads
3. Authentication: Script to enumerate valid usernames
4. IDOR: Try accessing other users' orders
5. Session: Test cookie manipulation

### Automated Testing:
- Update scripts in `scripts/security_tests/` to verify vulnerabilities work
- Create exploit scripts for each vulnerability

## Safety Measures

### Development Environment:
- Only run on localhost
- Use separate database for vulnerable version
- Clear warnings in UI about vulnerable version

### Code Organization:
- Clear comments marking vulnerable code
- Git branch separation (vulnerable branch)
- Documentation of original secure implementation

## Timeline

1. **Day 1**: Remove security features, implement SQL injection
2. **Day 2**: Implement XSS vulnerabilities and review system
3. **Day 3**: Implement authentication weaknesses and IDOR
4. **Day 4**: Testing and documentation
5. **Day 5**: Penetration testing report preparation

## Deliverables

1. **Modified Source Code**: With all vulnerabilities implemented
2. **Vulnerability Documentation**: Detailed exploitation guides
3. **Penetration Testing Report**: Professional report following OWASP methodology
4. **Proof-of-Concept Scripts**: Automated exploitation demonstrations
5. **Remediation Guide**: How to fix each vulnerability

## Notes

- Maintain functionality while introducing vulnerabilities
- Ensure vulnerabilities are exploitable but not immediately obvious
- Balance between realistic vulnerabilities and educational value
- Keep original secure code in main branch for comparison