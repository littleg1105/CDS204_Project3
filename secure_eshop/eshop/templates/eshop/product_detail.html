{% extends 'eshop/base.html' %}

{% block title %}{{ product.name }} - E-Shop{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p class="lead">{{ product.description }}</p>
            <p class="h4 text-primary">â‚¬{{ product.price }}</p>
            <p>Stock: {{ product.stock }} units</p>
            
            {% if user.is_authenticated %}
                <button class="btn btn-primary add-to-cart" data-product-id="{{ product.id }}">
                    Add to Cart
                </button>
            {% else %}
                <a href="{% url 'eshop:login' %}" class="btn btn-primary">Login to Purchase</a>
            {% endif %}
        </div>
    </div>

    <hr class="my-5">

    <!-- Reviews Section -->
    <div class="row">
        <div class="col-md-8">
            <h3>Customer Reviews</h3>
            
            {% if reviews %}
                <p>Average Rating: {{ avg_rating|floatformat:1 }} / 5</p>
                
                <!-- VULNERABILITY: XSS - Reviews displayed without escaping -->
                {% autoescape off %}
                {% for review in reviews %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <!-- VULNERABILITY: Title and content rendered without escaping -->
                            <h5 class="card-title">{{ review.title }}</h5>
                            <p class="card-text">{{ review.content }}</p>
                            <div class="text-muted">
                                <small>
                                    Rating: {{ review.rating }}/5 | 
                                    By {{ review.user.username }} | 
                                    {{ review.created_at|date:"F d, Y" }}
                                </small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% endautoescape %}
            {% else %}
                <p>No reviews yet. Be the first to review this product!</p>
            {% endif %}

            <!-- Review Form -->
            {% if user.is_authenticated and review_form %}
                <div class="mt-4">
                    <h4>Write a Review</h4>
                    <form method="post" action="{% url 'eshop:submit_review' product.id %}">
                        {% csrf_token %}
                        <div class="form-group">
                            {{ review_form.title.label_tag }}
                            {{ review_form.title }}
                        </div>
                        <div class="form-group">
                            {{ review_form.content.label_tag }}
                            {{ review_form.content }}
                        </div>
                        <div class="form-group">
                            {{ review_form.rating.label_tag }}
                            {{ review_form.rating }}
                        </div>
                        <button type="submit" class="btn btn-primary">Submit Review</button>
                    </form>
                </div>
            {% elif not user.is_authenticated %}
                <div class="mt-4">
                    <p><a href="{% url 'eshop:login' %}">Login</a> to write a review.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Add to cart functionality
document.addEventListener('DOMContentLoaded', function() {
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    
    addToCartButtons.forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            
            fetch('{% url "eshop:add_to_cart" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Product added to cart!');
                    // Update cart counter if exists
                    const cartCounter = document.querySelector('.cart-items-count');
                    if (cartCounter) {
                        cartCounter.textContent = data.cart_items_count;
                    }
                } else {
                    alert(data.message || 'Error adding to cart');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding to cart');
            });
        });
    });
});
</script>
{% endblock %}